<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¶”ì–µì˜ ì „ìŸ ê²Œì„</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Malgun Gothic', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 25%, #0f3460 50%, #1a1a2e 75%, #533483 100%);
            color: #fff;
            padding: 20px;
            position: relative;
        }
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 80%, rgba(255, 0, 0, 0.1) 0%, transparent 50%),
                        radial-gradient(circle at 80% 20%, rgba(0, 0, 255, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: -1;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            text-align: center;
            margin-bottom: 30px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .setup-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        .team-setup {
            background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
            padding: 14px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.08);
            box-shadow: 0 6px 18px rgba(0,0,0,0.35);
            max-height: 600px;
            overflow-y: auto;
        }
        .team-setup h2 {
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .team-name-input {
            flex: 1;
            padding: 8px;
            border-radius: 5px;
            border: none;
            font-size: 16px;
        }
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        .btn-primary:hover {
            background: #45a049;
        }
        .btn-secondary {
            background: #2196F3;
            color: white;
        }
        .btn-secondary:hover {
            background: #0b7dda;
        }
        .unit-config {
            margin: 10px 0;
            padding: 10px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
        }
        .unit-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .unit-controls {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .control-group label {
            font-size: 11px;
            opacity: 0.9;
        }
        .control-group input, .control-group select {
            padding: 4px;
            border-radius: 5px;
            border: none;
            font-size: 12px;
        }
        .battle-controls {
            text-align: center;
            margin: 20px 0;
        }
        .battle-controls .btn {
            font-size: 18px;
            padding: 15px 40px;
            margin: 0 10px;
        }
        .battlefield {
            border-radius: 15px;
            padding: 30px;
            min-height: 600px;
            position: relative;
            overflow: hidden;
            border: 3px solid rgba(255,255,255,0.2);
            box-shadow: inset 0 0 40px rgba(0,0,0,0.5);
        }
 
     
        .battlefield .armies-container {
            position: relative;
            z-index: 3;
        }
        .armies-container {
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            height: 100%;
            position: relative;
            gap: 20px;
        }
        .army-side {
            flex: 1;
            position: relative;
            border-right: 2px dashed rgba(255,255,255,0.2);
        }
        .army-side:last-child {
            border-right: none;
        }
        .army-side h3 {
            position: absolute;
            top: 10px;
            left: 10px;
            font-size: 18px;
            background: rgba(0,0,0,0.5);
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 5;
        }
        .soldier {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .soldier:hover {
            transform: scale(1.1);
        }
        .soldier:hover .soldier-details {
            display: block;
        }
        .soldier.archer:hover::before {
            content: '';
            position: absolute;
            width: 400px;
            height: 400px;
            border: 2px dashed rgba(0, 242, 254, 0.4);
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: -1;
        }
        .soldier-details {
            display: none;
        }
        .soldier-avatar {
            font-size: 40px;
            margin-bottom: 5px;
            filter: drop-shadow(0 0 5px rgba(255,255,255,0.5));
            transition: transform 0.1s;
        }
        .soldier.moving .soldier-avatar {
            animation: move-bounce 0.4s ease-in-out infinite;
        }
        .soldier.attacking .soldier-avatar {
            animation: attack-swing 0.2s ease-in-out;
        }
        .soldier-info {
            background: transparent;
            padding: 2px 0;
            border-radius: 0;
            font-size: 12px;
            min-width: 50px;
            text-align: center;
            border: none;
            visibility: visible;
            opacity: 1;
            transition: opacity 0.2s;
            z-index: 100;
            position: absolute;
            bottom: -18px;
            left: 50%;
            transform: translateX(-50%);
        }
        .soldier-info.knight {
            border-color: #f5576c;
        }
        .soldier-info.archer {
            border-color: #00f2fe;
        }
        .soldier-hp {
            font-weight: bold;
            color: #4CAF50;
            font-size: 13px;
            margin-bottom: 4px;
        }
        .health-bar {
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 4px;
            overflow: hidden;
            width: 80px;
        }
        .health-fill {
            height: 100%;
            transition: width 0.2s;
        }
        .team1 .health-fill {
            background: linear-gradient(90deg, #ff6b6b, #ff8787);
        }
        .team2 .health-fill {
            background: linear-gradient(90deg, #4ecdc4, #45b7aa);
        }
        .soldier-info.knight .health-fill {
            background: linear-gradient(90deg, #ff6b6b, #ff8787);
        }
        .soldier-info.archer .health-fill {
            background: linear-gradient(90deg, #4ecdc4, #45b7aa);
        }
        .health-fill.special-flash {
            animation: health-bar-flash 0.4s ease-out;
        }
        .soldier.invincible .health-fill {
            background: linear-gradient(90deg, #8a2be2, #c084fc) !important;
            box-shadow: 0 0 12px rgba(138,43,226,0.6);
        }
        .team-counts {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.6);
            padding: 6px 10px;
            border-radius: 8px;
            font-size: 12px;
            cursor: default;
            z-index: 10;
        }
        .team-counts .summary {
            font-weight: bold;
            color: #fff;
        }
        .team-counts .details {
            display: none;
            margin-top: 6px;
            background: rgba(255,255,255,0.03);
            padding: 6px;
            border-radius: 6px;
            text-align: left;
            white-space: nowrap;
            font-size: 11px;
        }
        .team-counts:hover .details { display: block; }

        .btn-fast { background: linear-gradient(90deg,#f6b73c,#ff7a18); color: #111; }
        @keyframes health-bar-flash {
            0% { filter: drop-shadow(0 0 8px rgba(128, 0, 255, 1)); }
            50% { filter: drop-shadow(0 0 15px rgba(128, 0, 255, 0.8)); }
            100% { filter: drop-shadow(0 0 3px rgba(128, 0, 255, 0)); }
        }
        .soldier-details {
            font-size: 10px;
            color: #aaa;
            margin-top: 4px;
            line-height: 1.3;
        }
        .genius-badge {
            display: inline-block;
            background: gold;
            color: #000;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: bold;
            margin-top: 2px;
        }
        .special-indicator {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 20px;
            animation: special-pulse 0.5s ease-out;
            pointer-events: none;
        }
        @keyframes special-pulse {
            0% { 
                transform: translateX(-50%) scale(0);
                opacity: 1;
            }
            100% { 
                transform: translateX(-50%) scale(1.5);
                opacity: 0;
            }
        }
        .cooldown-reduction {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            animation: cooldown-flash 0.6s ease-out;
            pointer-events: none;
        }
        @keyframes cooldown-flash {
            0% { 
                transform: translateX(-50%) scale(0);
                filter: drop-shadow(0 0 10px rgba(128, 0, 255, 1));
                opacity: 1;
            }
            50% {
                filter: drop-shadow(0 0 20px rgba(128, 0, 255, 0.8));
            }
            100% { 
                transform: translateX(-50%) scale(1);
                filter: drop-shadow(0 0 5px rgba(128, 0, 255, 0.3));
                opacity: 0;
            }
        }

        .soldier.hit-animation .soldier-avatar {
            animation: hit-shake 0.15s ease-out;
        }
        @keyframes hit-shake {
            0%, 100% { transform: translateX(0) scale(1); }
            25% { transform: translateX(-8px) scale(1.05); }
            75% { transform: translateX(8px) scale(0.95); }
        }
        @keyframes move-bounce {
            0%, 100% { transform: translateY(0) scaleY(1); }
            50% { transform: translateY(-5px) scaleY(0.95); }
        }
        @keyframes attack-swing {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.1) rotate(15deg); }
        }
        .battle-log {
            background: rgba(0,0,0,0.5);
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            max-height: 150px;
            overflow-y: auto;
            border: 2px solid rgba(255,255,255,0.2);
        }
        .log-entry {
            padding: 5px;
            margin: 2px 0;
            font-size: 12px;
            border-left: 3px solid #4CAF50;
            padding-left: 10px;
        }
        .log-entry.special {
            border-left-color: gold;
            background: rgba(255,215,0,0.15);
            color: #ffeb3b;
        }
        .log-entry.damage {
            border-left-color: #ff6b6b;
            background: rgba(255,107,107,0.1);
        }
        .winner-announce {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.95);
            padding: 60px 80px;
            border-radius: 20px;
            font-size: 48px;
            z-index: 2000;
            animation: winner-bounce 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: 4px solid gold;
            box-shadow: 0 0 60px rgba(255,215,0,0.8);
        }
        @keyframes winner-bounce {
            0% { transform: translate(-50%, -50%) scale(0) rotate(-180deg); }
            100% { transform: translate(-50%, -50%) scale(1) rotate(0deg); }
        }
        @keyframes fade-out-death {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(20px) scale(0.8); }
        }
        .soldier.dead {
            animation: fade-out-death 1s ease-out forwards;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>âš”ï¸ ì¶”ì–µì˜ ì „ìŸ ê²Œì„ âš”ï¸</h1>
        
        <div class="setup-area">
            <div class="team-setup">
                <h2>
                    <input type="text" class="team-name-input" id="team1Name" value="ë ˆë“œíŒ€" placeholder="íŒ€ ì´ë¦„">
                    <button class="btn btn-secondary" onclick="randomTeamName('team1Name')">ëœë¤</button>
                </h2>
                
                <div style="margin-bottom: 12px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <label style="font-size: 12px; font-weight: bold;">ì „ì²´ ë³‘ì‚¬:</label>
                        <input type="number" id="team1TotalCount" value="6" min="0" max="50" style="width: 50px; padding: 4px; border-radius: 5px; border: none; font-size: 12px;">
                        <button class="btn btn-primary" onclick="randomizeTeam1Config()" style="padding: 4px 8px; font-size: 11px;">ğŸ² ëœë¤</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label style="font-size: 12px; font-weight: bold;">ë²”ì£¼:</label>
                        <select id="team1ThemeSelect" onchange="switchTeam1Theme()" style="flex: 1; padding: 4px; border-radius: 5px; border: none; font-size: 12px;">
                            <option value="medieval">âš”ï¸ ì¤‘ì„¸</option>
                            <option value="mythology">ğŸ›ï¸ ì‹ í™”</option>
                        </select>
                    </div>
                </div>
                
                <div id="team1MedievalUnits" style="display: block;">
                    <!-- ì¤‘ì„¸ ìœ ë‹›ë“¤ -->
                </div>
                
                <div id="team1MythologyUnits" style="display: none;">
                    <!-- ì‹ í™” ìœ ë‹›ë“¤ -->
                </div>
            </div>

            <div class="team-setup">
                <h2>
                    <input type="text" class="team-name-input" id="team2Name" value="ë¸”ë£¨íŒ€" placeholder="íŒ€ ì´ë¦„">
                    <button class="btn btn-secondary" onclick="randomTeamName('team2Name')">ëœë¤</button>
                </h2>
                
                <div style="margin-bottom: 12px; padding: 8px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                    <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                        <label style="font-size: 12px; font-weight: bold;">ì „ì²´ ë³‘ì‚¬:</label>
                        <input type="number" id="team2TotalCount" value="6" min="0" max="50" style="width: 50px; padding: 4px; border-radius: 5px; border: none; font-size: 12px;">
                        <button class="btn btn-primary" onclick="randomizeTeam2Config()" style="padding: 4px 8px; font-size: 11px;">ğŸ² ëœë¤</button>
                    </div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <label style="font-size: 12px; font-weight: bold;">ë²”ì£¼:</label>
                        <select id="team2ThemeSelect" onchange="switchTeam2Theme()" style="flex: 1; padding: 4px; border-radius: 5px; border: none; font-size: 12px;">
                            <option value="medieval">âš”ï¸ ì¤‘ì„¸</option>
                            <option value="mythology">ğŸ›ï¸ ì‹ í™”</option>
                        </select>
                    </div>
                </div>
                
                <div id="team2MedievalUnits" style="display: block;">
                    <!-- ì¤‘ì„¸ ìœ ë‹›ë“¤ -->
                </div>
                
                <div id="team2MythologyUnits" style="display: none;">
                    <!-- ì‹ í™” ìœ ë‹›ë“¤ -->
                </div>
            </div>
        </div>

        <div class="battle-controls">
            <button class="btn btn-primary" onclick="startBattle()">âš”ï¸ ì „íˆ¬ ì‹œì‘</button>
            <button class="btn btn-secondary" onclick="resetBattle()">ğŸ”„ ì´ˆê¸°í™”</button>
            <button id="fastBtn" class="btn btn-fast" onclick="toggleFast()">â© ë¹ ë¥´ê²Œ</button>
            <button class="btn" style="background: linear-gradient(90deg, #ff6b6b, #ff4444); padding: 10px 20px; margin-left: 20px;" onclick="increaseDamage()" id="damageBtn">ğŸ’ª ê³µê²©ë ¥ +100% (100%)</button>
        </div>

        <div class="battlefield" id="battlefield"></div>

        <div class="battle-log" id="battleLog"></div>
    </div>

    <script>
        const teamNames = ['ë“œë˜ê³¤íŒ€', 'í”¼ë‹‰ìŠ¤íŒ€', 'íƒ€ì´íƒ„íŒ€', 'ë ˆì „ë“œíŒ€', 'ì„í˜ë¦¬ì–¼íŒ€', 'ë¹…í† ë¦¬íŒ€', 'ì—˜ë¦¬íŠ¸íŒ€', 'ì½˜í€˜ìŠ¤íŠ¸íŒ€'];
        let battleInterval;
        let units = { team1: [], team2: [] };
        let battleActive = false;
        let isFast = false;
        const speedMultiplier = 3;
        const intervalDelayBase = 20;
        const battlefield = document.getElementById('battlefield');
        let damageMultiplier = 1.0;

        // ì¤‘ì„¸ ìœ ë‹› HTML ìƒì„±
        const medievalUnitsHTML = `
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ—¡ï¸ ê¸°ì‚¬</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDKnightFrontCount" value="2" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDKnightBackCount" value="1" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDKnightSpecial" value="25" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ¹ ê¶ìˆ˜</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDArcherFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDArcherBackCount" value="2" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDArcherSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ¦ ìƒˆì¡ì´</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDSnowmanFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDSnowmanBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDSnowmanSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
   
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ›¡ï¸ ì‰´ë”</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDShielderFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDShielderBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDShielderSpecial" value="0" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>âš•ï¸ íëŸ¬</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDHealerFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDHealerBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDHealerSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ”¨ í•´ë¨¸ë§¨</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDHammermanFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDHammermanBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDHammermanSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ’£ í­íƒ„ë³‘</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDBombermanFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDBombermanBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDBombermanSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ¥· ë‹Œì</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDNinjaFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDNinjaBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDNinjaSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ›– ë™êµ´</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDCaveFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDCaveBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì†Œí™˜</label>
                        <select id="TEAM_IDCaveSpawnType" style="padding: 4px; border-radius: 5px; border: none; font-size: 11px;">
                            <option value="knight">ğŸ—¡ï¸ ê¸°ì‚¬</option>
                            <option value="archer">ğŸ¹ ê¶ìˆ˜</option>
                            <option value="snowman">ğŸ¦ ìƒˆì¡ì´</option>
                            <option value="golem">ğŸ—¿ ê³¨ë ˜</option>
                            <option value="shielder">ğŸ›¡ï¸ ì‰´ë”</option>
                            <option value="healer">âš•ï¸ íëŸ¬</option>
                            <option value="bomberman">ğŸ’£ í­íƒ„ë³‘</option>
                            <option value="hammerman">ğŸ”¨ í•´ë¨¸ë§¨</option>
                            <option value="ninja">ğŸ¥· ë‹Œì</option>
                        </select>
                    </div>
                </div>
            </div>
        `;

        // ì‹ í™” ìœ ë‹› HTML ìƒì„±
        const mythologyUnitsHTML = `
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ‘¹ ì˜¤í¬</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDOrcFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDOrcBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDOrcSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ‘¼ ì²œì‚¬</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDAngelFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDAngelBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDAngelSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
                <div class="unit-header"><strong>ğŸ˜ˆ ì‚¬íƒ„</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDSatanFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDSatanBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDSatanSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
                     <div class="unit-config">
                <div class="unit-header"><strong>ğŸ—¿ ê³¨ë ˜</strong></div>
                <div class="unit-controls">
                    <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDGolemFrontCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDGolemBackCount" value="0" min="0" max="10"></div>
                    <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDGolemSpecial" value="20" min="0" max="100"></div>
                </div>
            </div>
            <div class="unit-config">
    <div class="unit-header"><strong>ğŸ¦„ ìœ ë‹ˆì½˜</strong></div>
    <div class="unit-controls">
        <div class="control-group"><label>ì „ë°©</label><input type="number" id="TEAM_IDUnicornFrontCount" value="0" min="0" max="10"></div>
        <div class="control-group"><label>í›„ë°©</label><input type="number" id="TEAM_IDUnicornBackCount" value="0" min="0" max="10"></div>
        <div class="control-group"><label>ì¹˜ëª…(%)</label><input type="number" id="TEAM_IDUnicornSpecial" value="20" min="0" max="100"></div>
    </div>
</div>
        `;

        // ì´ˆê¸°í™”
        document.getElementById('team1MedievalUnits').innerHTML = medievalUnitsHTML.replace(/TEAM_ID/g, 'team1');
        document.getElementById('team1MythologyUnits').innerHTML = mythologyUnitsHTML.replace(/TEAM_ID/g, 'team1');
        document.getElementById('team2MedievalUnits').innerHTML = medievalUnitsHTML.replace(/TEAM_ID/g, 'team2');
        document.getElementById('team2MythologyUnits').innerHTML = mythologyUnitsHTML.replace(/TEAM_ID/g, 'team2');

        function switchTeam1Theme() {
            const theme = document.getElementById('team1ThemeSelect').value;
            if (theme === 'medieval') {
                document.getElementById('team1MedievalUnits').style.display = 'block';
                document.getElementById('team1MythologyUnits').style.display = 'none';
            } else {
                document.getElementById('team1MedievalUnits').style.display = 'none';
                document.getElementById('team1MythologyUnits').style.display = 'block';
            }
        }

        function switchTeam2Theme() {
            const theme = document.getElementById('team2ThemeSelect').value;
            if (theme === 'medieval') {
                document.getElementById('team2MedievalUnits').style.display = 'block';
                document.getElementById('team2MythologyUnits').style.display = 'none';
            } else {
                document.getElementById('team2MedievalUnits').style.display = 'none';
                document.getElementById('team2MythologyUnits').style.display = 'block';
            }
        }

        function setBattleInterval() {
            clearInterval(battleInterval);
            const delay = Math.max(1, Math.floor(intervalDelayBase / (isFast ? speedMultiplier : 1)));
            battleInterval = setInterval(battleLoop, delay);
        }

        function toggleFast() {
            const now = Date.now();
            isFast = !isFast;
            [units.team1, units.team2].flat().forEach(u => {
                ['nextAttackTime','nextHealTime','nextShieldTime','shieldEndTime'].forEach(key => {
                    if (!u[key]) return;
                    const remaining = u[key] - now;
                    if (remaining <= 0) return;
                    if (isFast) {
                        u[key] = now + Math.floor(remaining / speedMultiplier);
                    } else {
                        u[key] = now + Math.floor(remaining * speedMultiplier);
                    }
                });
            });
            setBattleInterval();
            const btn = document.getElementById('fastBtn');
            if (btn) btn.textContent = isFast ? 'â© ë¹ ë¥´ê²Œ(ON)' : 'â© ë¹ ë¥´ê²Œ';
        }

        function randomTeamName(inputId) {
            const name = teamNames[Math.floor(Math.random() * teamNames.length)];
            document.getElementById(inputId).value = name;
        }

        function increaseDamage() {
            if (!battleActive) {
                alert('ì „íˆ¬ ì¤‘ì—ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (damageMultiplier >= 5.0) {
                alert('ìµœëŒ€ ê³µê²©ë ¥ ì¦ê°€ ë°°ìˆ˜(500%)ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤.');
                return;
            }
            
            damageMultiplier += 1.0;
            
            const percent = Math.round((damageMultiplier - 1.0) * 100);
            document.getElementById('damageBtn').textContent = `ğŸ’ª ê³µê²©ë ¥ +100% (${percent}%)`;
            
            addLog(`ğŸ’ª ì „ì²´ ë³‘ì‚¬ì˜ ê³µê²©ë ¥ì´ ${percent}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤! (ì´ ${Math.round(damageMultiplier * 100)}% ì ìš©)`, true);
        }

        function randomizeTeamConfig(teamId) {
// ë³€ê²½ í›„:
let unitTypes = ['Knight', 'Archer', 'Snowman', 'Golem', 'Shielder', 'Healer', 'Bomberman', 'Hammerman', 'Ninja', 'Cave'];

// ì‹ í™” í…Œë§ˆì´ë©´ ì¶”ê°€
const themeSelect = document.getElementById(`team${teamId}ThemeSelect`);
if (themeSelect && themeSelect.value === 'mythology') {
    unitTypes.push('Orc', 'Angel', 'Satan', 'Unicorn'); // Unicorn ì¶”ê°€
}

            if (totalCount === 0) {
                alert('ë³‘ì‚¬ ìˆ˜ë¥¼ 1 ì´ìƒìœ¼ë¡œ ì„¤ì •í•˜ì„¸ìš”.');
                return;
            }
            
            const unitCounts = {};
            const numUnits = unitTypes.length;
            const baseCount = Math.floor(totalCount / numUnits);
            const remainder = totalCount % numUnits;
            
            unitTypes.forEach((unitType, idx) => {
                unitCounts[unitType] = baseCount;
            });
            
            let randomIndices = [];
            for (let i = 0; i < numUnits; i++) {
                randomIndices.push(i);
            }
            for (let i = randomIndices.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [randomIndices[i], randomIndices[j]] = [randomIndices[j], randomIndices[i]];
            }
            
            for (let i = 0; i < remainder; i++) {
                unitCounts[unitTypes[randomIndices[i]]]++;
            }
            
          unitTypes.forEach(unitType => {
    const total = unitCounts[unitType];
    const frontEl = document.getElementById(`team${teamId}${unitType}FrontCount`);
                const backEl = document.getElementById(`team${teamId}${unitType}BackCount`);
                
                if (frontEl && backEl) {
                    if (total === 0) {
                        frontEl.value = 0;
                        backEl.value = 0;
                    } else {
                        const frontCount = Math.floor(Math.random() * (total + 1));
                        const backCount = total - frontCount;
                        frontEl.value = frontCount;
                        backEl.value = backCount;
                    }
                }
            });
            
            alert(`ğŸ² ${teamId === 1 ? 'ë ˆë“œíŒ€' : 'ë¸”ë£¨íŒ€'} ëœë¤ ë°°ì • ì™„ë£Œ!\nì´ ${totalCount}ëª…ì˜ ë³‘ì‚¬ê°€ ë°°ì •ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        }

        function randomizeTeam1Config() {
            randomizeTeamConfig(1);
        }

        function randomizeTeam2Config() {
            randomizeTeamConfig(2);
        }

        class Unit {
            constructor(type, team, star, specialChance, index) {
                this.type = type;
                this.team = team;
                this.star = star;
                this.specialChance = specialChance;
                this.index = index;
                this.alive = true;
                this.nextAttackTime = 0;
                this.nextHealTime = 0;
                this.healInterval = 4000;
                this.x = 0;
                this.y = 0;
                this.specialActive = false;

                if (type === 'knight') {
                    this.maxHp = 130;
                    this.hp = this.maxHp;
                    this.baseDamage = 20;
                    this.damage = 20;
                    this.baseAttackSpeed = 3000;
                    this.attackSpeed = 3000;
                    this.speed = 2;
                    this.range = 80;
                    this.theme = 'medieval';
                } else if (type === 'archer') {
                    this.maxHp = 80;
                    this.hp = this.maxHp;
                    this.baseDamage = 25;
                    this.damage = 25;
                    this.baseAttackSpeed = 4600;
                    this.attackSpeed = 4600;
                    this.speed = 1.7;
                    this.range = 400;
                    this.theme = 'medieval';
                } else if (type === 'snowman') {
                    this.maxHp = 50;
                    this.hp = this.maxHp;
                    this.baseDamage = 10;
                    this.damage = 10;
                    this.baseAttackSpeed = 2000;
                    this.attackSpeed = 2000;
                    this.speed = 1;
                    this.range = 650;
                    this.theme = 'medieval';
                } else if (type === 'healer') {
                    this.maxHp = 100;
                    this.hp = this.maxHp;
                    this.baseDamage = 5;
                    this.damage = 5;
                    this.baseAttackSpeed = 8000;
                    this.attackSpeed = 8000;
                    this.speed = 1;
                    this.range = 200;
                    this.healInterval = 4000;
                    this.theme = 'medieval';
                } else if (type === 'orc') {
                    this.maxHp = 110;
                    this.hp = this.maxHp;
                    this.baseDamage = 20;
                    this.damage = 20;
                    this.baseAttackSpeed = 2500;
                    this.attackSpeed = 2500;
                    this.speed = 2.5;
                    this.range = 120;
                    this.theme = 'mythology';
                } else if (type === 'shielder') {
                    this.maxHp = 175;
                    this.hp = this.maxHp;
                    this.baseDamage = 15;
                    this.damage = 15;
                    this.baseAttackSpeed = 3000;
                    this.attackSpeed = 3000;
                    this.speed = 0.8;
                    this.range = 60;
                    this.theme = 'medieval';
                    this.shieldDuration = 2000;
                    this.shieldCooldownAfterEnd = 6000;
                    this.isInvincible = false;
                    this.nextShieldTime = Date.now() + 6000;
                } else if (type === 'bomberman') {
                    this.maxHp = 100;
                    this.hp = this.maxHp;
                    this.baseDamage = 30;
                    this.damage = 30;
                    this.baseAttackSpeed = 4000;
                    this.attackSpeed = 4000;
                    this.speed = 2.2;
                    this.range = 100;
                    this.theme = 'medieval';
                    this.bombs = [];
                    this.bombDuration = 3000;
                    this.bombSplashRange = 340;
                    this.bombDamage = 30;
                    this.bombSelfDamage = 25;
                } else if (type === 'hammerman') {
                    this.maxHp = 200;
                    this.hp = this.maxHp;
                    this.baseDamage = 10;
                    this.damage = 10;
                    this.baseAttackSpeed = 2200;
                    this.attackSpeed = 2200;
                    this.speed = 1.5;
                    this.range = 80;
                    this.splashRange = 10;
                    this.theme = 'medieval';
                } else if (type === 'cave') {
                    this.maxHp = 255;
                    this.hp = this.maxHp;
                    this.baseDamage = 5;
                    this.damage = 5;
                    this.baseAttackSpeed = 11000;
                    this.attackSpeed = 11000;
                    this.speed = 0.1;
                    this.range = 660;
                    this.theme = 'medieval';
                    this.nextSpawnTime = 0;
                    this.firstSpawnInterval = 6000;
                    this.spawnInterval = 12000;
                    this.spawnType = 'knight';
                    this.spawnCost = 50;
                    this.hasSpawned = false;
                } else if (type === 'ninja') {
                    this.maxHp = 110;
                    this.hp = this.maxHp;
                    this.baseDamage = 5;
                    this.damage = 5;
                    this.baseAttackSpeed = 800;
                    this.attackSpeed = 800;
                    this.speed = 3;
                    this.range = 120;
                    this.hasRetreated = false;
                    this.theme = 'medieval';
                } else if (type === 'angel') {
                    this.maxHp = 100;
                    this.hp = this.maxHp;
                    this.baseDamage = 5;
                    this.damage = 5;
                    this.baseAttackSpeed = 11000;
                    this.attackSpeed = 11000;
                    this.speed = 1;
                    this.range = 450;
                    this.theme = 'mythology';
                    this.reviveCount = 5;
                    this.reviveCheckInterval = 500;
                    this.nextReviveCheckTime = 0;
                    this.recentDeaths = [];
                } else if (type === 'satan') {
                    this.maxHp = 250;
                    this.hp = this.maxHp;
                    this.baseDamage = 0;
                    this.damage = 0;
                    this.baseAttackSpeed = 8000;
                    this.attackSpeed = 8000;
                    this.speed = 1.5;
                    this.range = 800;
                    this.theme = 'mythology';
                    this.possessionDuration = 4000;
                 } else if (type === 'unicorn') {
    this.maxHp = 200;
    this.hp = this.maxHp;
    this.baseDamage = 10;
    this.damage = 10;
    this.baseAttackSpeed = 3000;
    this.attackSpeed = 3000;
    this.speed = 0.6;
    this.range = 100;
    this.theme = 'mythology';
    this.chargeLevel = 0;
    this.isCharging = false;
    this.hasRetreated = false;
                    
                } else {
                    this.maxHp = 310;
                    this.hp = this.maxHp;
                    this.baseDamage = 80;
                    this.damage = 80;
                    this.baseAttackSpeed = 10000;
                    this.attackSpeed = 10000;
                    this.speed = 0.3;
                    this.range = 60;
                    this.splashRange = 80;
                    this.theme = 'mythology';
                }
                
                this.element = this.createElement();
                this.infoElement = this.element.querySelector('.soldier-info');
                this.nextAttackTime = this.nextAttackTime || 0;
                this.nextHealTime = this.nextHealTime || 0;
                this.nextShieldTime = this.nextShieldTime || 0;
                this.shieldEndTime = this.shieldEndTime || 0;
            }

            createElement() {
                const div = document.createElement('div');
                div.className = `soldier ${this.type}`;
                div.id = `${this.team}-${this.type}-${this.index}`;
                
                let icon, typeLabel;
                if (this.type === 'knight') {
                    icon = 'ğŸ—¡ï¸';
                    typeLabel = 'ê¸°ì‚¬';
                } else if (this.type === 'archer') {
                    icon = 'ğŸ¹';
                    typeLabel = 'ê¶ìˆ˜';
                } else if (this.type === 'snowman') {
                    icon = 'ğŸ¦';
                    typeLabel = 'ìƒˆì¡ì´';
                } else if (this.type === 'healer') {
                    icon = 'âš•ï¸';
                    typeLabel = 'íëŸ¬';
                } else if (this.type === 'shielder') {
                    icon = 'ğŸ›¡ï¸';
                    typeLabel = 'ì‰´ë”';
                } else if (this.type === 'bomberman') {
                    icon = 'ğŸ’£';
                    typeLabel = 'í­íƒ„ë³‘';
                } else if (this.type === 'hammerman') {
                    icon = 'ğŸ”¨';
                    typeLabel = 'í•´ë¨¸ë§¨';
                } else if (this.type === 'cave') {
                    icon = 'ğŸ›–';
                    typeLabel = 'ë™êµ´';
                } else if (this.type === 'ninja') {
                    icon = 'ğŸ¥·';
                    typeLabel = 'ë‹Œì';
                } else if (this.type === 'orc') {
                    icon = 'ğŸ‘¹';
                    typeLabel = 'ì˜¤í¬';
                } else if (this.type === 'angel') {
                    icon = 'ğŸ‘¼';
                    typeLabel = 'ì²œì‚¬';
                } else if (this.type === 'satan') {
                    icon = 'ğŸ˜ˆ';
                    typeLabel = 'ì‚¬íƒ„';
                    } else if (this.type === 'unicorn') {
    icon = 'ğŸ¦„';
    typeLabel = 'ìœ ë‹ˆì½˜';
                } else {
                    icon = 'ğŸ—¿';
                    typeLabel = 'ê³¨ë ˜';
                }
                const geniusBadge = '';
                const starDisplay = '';
                
                let extraInfo = '';
                if (this.type === 'angel') {
                    extraInfo = `<div style="color: gold; font-size: 11px; font-weight: bold;">ë¶€í™œ: ${this.reviveCount}</div>`;
                } else if (this.type === 'unicorn') {
    extraInfo = `<div class="charge-level" style="color: #ff69b4; font-size: 11px; font-weight: bold;">ì°¨ì§€: 0/6 (10 dmg)</div>`;
}
                
                div.innerHTML = `
                    <div class="soldier-avatar">${icon}</div>
                    <div class="soldier-info ${this.type}">
                        <div class="health-bar">
                            <div class="health-fill" style="width: 100%"></div>
                        </div>
                        <div class="soldier-details">
                            <div class="soldier-hp">HP: <span class="hp-text">${Math.floor(this.hp)}</span>/${this.maxHp}</div>
                            <div>${starDisplay} ${starDisplay ? '| ' : ''}${typeLabel}</div>
                            <div>ê³µê²©ë ¥: ${Math.floor(this.damage)}</div>
                            ${geniusBadge}
                            ${extraInfo}
                        </div>
                    </div>
                `;
                const healthFill = div.querySelector('.health-fill');
                if (healthFill) {
                    if (this.type === 'knight') {
                        healthFill.style.background = 'linear-gradient(90deg, #ff6b6b, #ff8787)';
                    } else if (this.type === 'archer') {
                        healthFill.style.background = 'linear-gradient(90deg, #4ecdc4, #45b7aa)';
                    }
                }

                this.row = 'front';

                return div;
            }

setTeamColor() {
    const healthFill = this.infoElement?.querySelector('.health-fill');
    if (healthFill) {
        healthFill.style.background = '';
        const team1Name = units.team1[0]?.team;
        if (this.team === team1Name) {
            healthFill.style.background = 'linear-gradient(90deg, #ff6b6b, #ff8787)';
        } else {
            healthFill.style.background = 'linear-gradient(90deg, #4ecdc4, #45b7aa)';
        }
    }
}

            updateDisplay() {
                if (!this.alive) return;
                const hpPercent = (this.hp / this.maxHp) * 100;
                this.infoElement.querySelector('.health-fill').style.width = `${hpPercent}%`;
                this.infoElement.querySelector('.hp-text').textContent = Math.max(0, Math.floor(this.hp));
            }

          moveTowards(target) {
    if (!target || !target.alive) return;
    
    const team1Side = document.getElementById('team1-side');
    const team2Side = document.getElementById('team2-side');
    
    let unitAbsX, unitAbsY, targetAbsX, targetAbsY;
    
    if (team1Side && team2Side) {
        const team1Rect = team1Side.getBoundingClientRect();
        const team2Rect = team2Side.getBoundingClientRect();
        
        // ë³€ê²½: units.team1[0].team ëŒ€ì‹  ì‹¤ì œ íŒ€1 ì´ë¦„ ì‚¬ìš©
        const team1Name = units.team1[0]?.team;
        
        if (this.team === team1Name) {
            unitAbsX = team1Rect.left + this.x;
            unitAbsY = team1Rect.top + this.y;
            targetAbsX = team2Rect.left + target.x;
            targetAbsY = team2Rect.top + target.y;
        } else {
            unitAbsX = team2Rect.left + this.x;
            unitAbsY = team2Rect.top + this.y;
            targetAbsX = team1Rect.left + target.x;
            targetAbsY = team1Rect.top + target.y;
        }
        
        const dx = targetAbsX - unitAbsX;
        const dy = targetAbsY - unitAbsY;
        const distance = Math.sqrt(dx * dx + dy * dy);

        if (distance > this.range && distance > 0) {
            let moveX = (dx / distance) * this.speed;
            let moveY = (dy / distance) * this.speed;
            
            // ë³€ê²½: allUnits ì‚¬ìš©
            const allUnits = [...units.team1, ...units.team2];
            const teamUnits = allUnits.filter(u => u.team === this.team);
            
            teamUnits.forEach(other => {
                if (other !== this && other.alive) {
                    const otherAbsX = this.team === team1Name ? 
                        team1Rect.left + other.x : team2Rect.left + other.x;
                    const otherAbsY = this.team === team1Name ? 
                        team1Rect.top + other.y : team2Rect.top + other.y;
                    
                    const distToOther = Math.sqrt((otherAbsX - unitAbsX) ** 2 + (otherAbsY - unitAbsY) ** 2);
                    
                    if (distToOther < 30 && distToOther > 0) {
                        const avoidX = (unitAbsX - otherAbsX) / distToOther;
                        const avoidY = (unitAbsY - otherAbsY) / distToOther;
                        moveX = moveX * 0.7 + avoidX * 0.3;
                        moveY = moveY * 0.7 + avoidY * 0.3;
                    }
                }
            });
            
            this.x += moveX;
            this.y += moveY;
            this.element.style.transform = `translate(${this.x}px, ${this.y}px)`;
            this.element.classList.add('moving');
        } else {
            this.element.classList.remove('moving');
        }
    }
}

       takeDamage(damage, ignoreInvincible = false) {
    if (this.isInvincible && !ignoreInvincible) {
        this.flashHealthBar();
        const label = this.type === 'knight' ? 'ê¸°ì‚¬' : this.type === 'archer' ? 'ê¶ìˆ˜' : this.type === 'snowman' ? 'ìƒˆì¡ì´' : this.type === 'golem' ? 'ê³¨ë ˜' : this.type === 'healer' ? 'íëŸ¬' : this.type === 'shielder' ? 'ì‰´ë”' : '';
        addLog(`${this.team} ${label}ì´(ê°€) ë¬´ì ìœ¼ë¡œ ë°ë¯¸ì§€ë¥¼ ë¬´ì‹œí–ˆìŠµë‹ˆë‹¤!`, false);
        return;
    }
                this.hp -= damage;
                this.element.classList.add('hit-animation');
                setTimeout(() => this.element.classList.remove('hit-animation'), 150);

                if (this.hp <= 0) {
                    this.hp = 0;
                    
               
 
                    this.alive = false;
                    this.element.classList.add('dead');
                    
                    const allies = this.team === units.team1[0].team ? units.team1 : units.team2;
                    allies.forEach(ally => {
                        if (ally.type === 'angel' && ally.alive && !ally.isPossessed) {
                            if (!ally.recentDeaths) ally.recentDeaths = [];
                            ally.recentDeaths.push({
                                unit: this,
                                deathTime: Date.now(),
                                x: this.x,
                                y: this.y
                            });
                        }
                    });
                    
                    this.deathTimeout = setTimeout(() => {
                        if (this.element && this.element.parentNode) {
                            this.element.parentNode.removeChild(this.element);
                        }
                    }, 1000);
                }
                this.updateDisplay();
            }
attack(target) {
    if (!this.alive || !target.alive) return;

    const team1Name = units.team1[0]?.team;
    const now = Date.now();

    // â˜… ì‚¬íƒ„ì€ ê²Œì„ ì‹œì‘ í›„ 3ì´ˆ ë’¤ë¶€í„° ê³µê²© ê°€ëŠ¥
    if (this.type === 'satan' && this.nextAttackTime === 0) {
        this.nextAttackTime = now + 3000;
        return;
    }

                if (this.type === 'healer') {
                    if (now < this.nextHealTime) return;
                    const allies = this.team === units.team1[0].team ? units.team1 : units.team2;
                    allies.forEach(a => {
                        if (a.alive && a.type !== 'cave') {
                            let healMultiplier = 1.0;
                            if (a.theme && a.theme !== 'medieval') {
                                healMultiplier = 0.1;
                            }
                            const healAmount = Math.floor(a.maxHp * 0.2 * healMultiplier);
                            a.hp = Math.min(a.maxHp, a.hp + healAmount);
                            a.updateDisplay();
                            a.flashHealthBar();
                        }
                    });
                    addLog(`${this.team} íëŸ¬ê°€ ì•„êµ°ì„ íšŒë³µí–ˆìŠµë‹ˆë‹¤!`, true);
                    this.nextHealTime = now + this.healInterval;
                    return;
                }

                // ìœ ë‹ˆì½˜ ì°¨ì§€ ì‹œìŠ¤í…œ
// ì´ ë¶€ë¶„ ì „ì²´ ì‚­ì œ
if (this.type === 'unicorn') {
    if (now >= this.nextChargeTime && this.chargeLevel < this.maxChargeLevel) {
        this.chargeLevel++;
        this.damage = this.baseDamage + (this.chargeLevel * 10);
        this.nextChargeTime = now + this.chargeInterval;
        this.updateChargeDisplay();
        addLog(`${this.team} ìœ ë‹ˆì½˜ì˜ ì°¨ì§€ ë ˆë²¨ ì¦ê°€! (${this.chargeLevel}/6, ê³µê²©ë ¥: ${this.damage})`, true);
    }
}

// ì¼ë°˜ ê³µê²© ë¡œì§ (ê±°ë¦¬ ì²´í¬ ë¶€ë¶„ ë‹¤ìŒ)
if (this.type === 'unicorn' && this.chargeLevel >= 2) {
    // 2ì°¨ì§€ ì´ìƒì¼ ë•Œ í›„í‡´
    const team1Side = document.getElementById('team1-side');
    const team2Side = document.getElementById('team2-side');
    const sideEl = this.team === units.team1[0].team ? team1Side : team2Side;
    
    if (this.team === units.team1[0].team) {
        this.x = Math.max(0, this.x - 150);
    } else {
        this.x = Math.min(sideEl.offsetWidth - 40, this.x + 150);
    }
    this.element.style.transform = `translate(${this.x}px, ${this.y}px)`;
    addLog(`${this.team} ìœ ë‹ˆì½˜ì´ í›„í‡´í–ˆìŠµë‹ˆë‹¤!`, false);
}

                if (this.type === 'shielder') {
                    if (!this.isInvincible && now >= (this.nextShieldTime || 0)) {
                        this.isInvincible = true;
                        if (this.element && this.element.classList) this.element.classList.add('invincible');
                        this.shieldEndTime = now + this.shieldDuration;
                        addLog(`${this.team} ì‰´ë”ê°€ ë¬´ì ì„ í™œì„±í™”í–ˆìŠµë‹ˆë‹¤! (2ì´ˆ)`, true);
                        this.flashHealthBar();
                    }
                }

                if (now < this.nextAttackTime) return;

                if (this.type === 'cave') {
                    if (this.nextSpawnTime === 0) {
                        this.nextSpawnTime = now + this.firstSpawnInterval;
                        return;
                    }
                    
                    if (now >= this.nextSpawnTime) {
                        if (this.hp > this.spawnCost) {
                            this.hp -= this.spawnCost;
                            this.updateDisplay();
                            
                            const spawnedUnit = new Unit(this.spawnType, this.team, 1, 20, Math.random() * 1000);
                            spawnedUnit.row = 'front';
                            spawnedUnit.x = this.x + (this.team === units.team1[0].team ? 50 : -50);
                            spawnedUnit.y = this.y + (Math.random() - 0.5) * 40;
                            
                            if (this.team === units.team1[0].team) {
                                units.team1.push(spawnedUnit);
                            } else {
                                units.team2.push(spawnedUnit);
                            }
                            
                            const sideId = this.team === units.team1[0].team ? 'team1-side' : 'team2-side';
                            const side = document.getElementById(sideId);
                            if (side) {
                                spawnedUnit.element.style.transform = `translate(${spawnedUnit.x}px, ${spawnedUnit.y}px)`;
                                side.appendChild(spawnedUnit.element);
                                spawnedUnit.element.classList.add(this.team === units.team1[0].team ? 'team1' : 'team2');
                                spawnedUnit.setTeamColor();
                            }
                            
                            const typeLabel = this.spawnType === 'knight' ? 'ê¸°ì‚¬' : this.spawnType === 'archer' ? 'ê¶ìˆ˜' : this.spawnType === 'snowman' ? 'ìƒˆì¡ì´' : this.spawnType === 'ninja' ? 'ë‹Œì' : this.spawnType === 'golem' ? 'ê³¨ë ˜' : this.spawnType === 'shielder' ? 'ì‰´ë”' : this.spawnType === 'healer' ? 'íëŸ¬' : this.spawnType === 'hammerman' ? 'í•´ë¨¸ë§¨' : 'í­íƒ„ë³‘';
                            addLog(`${this.team} ë™êµ´ì´ ${typeLabel}ì„(ë¥¼) ì†Œí™˜í–ˆìŠµë‹ˆë‹¤! (ì²´ë ¥ -${this.spawnCost})`, true);
                        }
                        this.nextSpawnTime = now + this.spawnInterval;
                    }
                    return;
                }

                if (this.type === 'angel') {
                    if (now < this.nextReviveCheckTime) return;
                    
                    if (this.recentDeaths && this.recentDeaths.length > 0 && this.reviveCount > 0) {
                        const death = this.recentDeaths.shift();
                        const deadUnit = death.unit;
                        
                        if (deadUnit.type === 'angel' || deadUnit.type === 'cave') {
                            return;
                        }
                        
                        const costToRevive = (deadUnit.theme === 'mythology') ? 1 : 2;
                        
                        if (costToRevive === 2 && this.reviveCount === 1) {
                            return;
                        }
                        
                        if (this.reviveCount >= costToRevive) {
                            if (deadUnit.deathTimeout) {
                                clearTimeout(deadUnit.deathTimeout);
                                deadUnit.deathTimeout = null;
                            }
                            
                            deadUnit.alive = true;
                            deadUnit.hp = Math.floor(deadUnit.maxHp * 0.7);
                            deadUnit.x = death.x;
                            deadUnit.y = death.y;
                            
                            deadUnit.element.classList.remove('dead');
                            deadUnit.element.style.opacity = '1';
                            deadUnit.element.style.transform = `translate(${deadUnit.x}px, ${deadUnit.y}px)`;
                            
                            const sideId = this.team === units.team1[0].team ? 'team1-side' : 'team2-side';
                            const side = document.getElementById(sideId);
                            if (side && !deadUnit.element.parentNode) {
                                side.appendChild(deadUnit.element);
                            }
                            
                            deadUnit.updateDisplay();
                            
                            const team1Side = document.getElementById('team1-side');
                            const team2Side = document.getElementById('team2-side');
                            const enemies = this.team === units.team1[0].team ? units.team2 : units.team1;
                            
                            if (team1Side && team2Side) {
                                const team1Rect = team1Side.getBoundingClientRect();
                                const team2Rect = team2Side.getBoundingClientRect();
                                const allyRect = this.team === units.team1[0].team ? team1Rect : team2Rect;
                                const enemyRect = this.team === units.team1[0].team ? team2Rect : team1Rect;
                                const enemySide = this.team === units.team1[0].team ? team2Side : team1Side;
                                
                                const revivedAbsX = allyRect.left + deadUnit.x;
                                const revivedAbsY = allyRect.top + deadUnit.y;
                                
                                enemies.forEach(enemy => {
                                    if (enemy.alive) {
                                        const enemyAbsX = enemyRect.left + enemy.x;
                                        const enemyAbsY = enemyRect.top + enemy.y;
                                        const distToEnemy = Math.sqrt((enemyAbsX - revivedAbsX) ** 2 + (enemyAbsY - revivedAbsY) ** 2);
                                        
                                        if (distToEnemy <= 150) {
                                            const pushAmount = 200;
                                            if (this.team === units.team1[0].team) {
                                                enemy.x = Math.min(enemy.x + pushAmount, enemySide.offsetWidth - 40);
                                            } else {
                                                enemy.x = Math.max(enemy.x - pushAmount, 40);
                                            }
                                            enemy.element.style.transform = `translate(${enemy.x}px, ${enemy.y}px)`;
                                        }
                                    }
                                });
                            }
                            
                            this.reviveCount -= costToRevive;
                            this.updateReviveCounter();
                            
                            const unitLabel = deadUnit.type === 'knight' ? 'ê¸°ì‚¬' : deadUnit.type === 'archer' ? 'ê¶ìˆ˜' : deadUnit.type === 'snowman' ? 'ìƒˆì¡ì´' : deadUnit.type === 'golem' ? 'ê³¨ë ˜' : deadUnit.type === 'healer' ? 'íëŸ¬' : deadUnit.type === 'shielder' ? 'ì‰´ë”' : deadUnit.type === 'hammerman' ? 'í•´ë¨¸ë§¨' : deadUnit.type === 'ninja' ? 'ë‹Œì' : deadUnit.type === 'orc' ? 'ì˜¤í¬' : deadUnit.type === 'bomberman' ? 'í­íƒ„ë³‘' : '';
                            addLog(`${this.team} ì²œì‚¬ê°€ ${unitLabel}ì„(ë¥¼) ë¶€í™œì‹œì¼°ìŠµë‹ˆë‹¤! (ë‚¨ì€ íšŸìˆ˜: ${this.reviveCount})`, true);
                        }
                    }
                    
                    this.nextReviveCheckTime = now + this.reviveCheckInterval;
                    return;
                }

                if (this.type === 'bomberman') {
                    const team1Side = document.getElementById('team1-side');
                    const team2Side = document.getElementById('team2-side');
                    
                    if (team1Side && team2Side) {
                        const team1Rect = team1Side.getBoundingClientRect();
                        const team2Rect = team2Side.getBoundingClientRect();
                        
                        let unitAbsX, unitAbsY, targetAbsX, targetAbsY;
                        if (this.team === units.team1[0].team) {
                            unitAbsX = team1Rect.left + this.x;
                            unitAbsY = team1Rect.top + this.y;
                            targetAbsX = team2Rect.left + target.x;
                            targetAbsY = team2Rect.top + target.y;
                        } else {
                            unitAbsX = team2Rect.left + this.x;
                            unitAbsY = team2Rect.top + this.y;
                            targetAbsX = team1Rect.left + target.x;
                            targetAbsY = team1Rect.top + target.y;
                        }
                        
                        const dx = targetAbsX - unitAbsX;
                        const dy = targetAbsY - unitAbsY;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance <= this.range && target.alive) {
                            const bombExplosionTime = now + this.bombDuration;
                            this.bombs.push({ target: target, placedTime: now, explosionTime: bombExplosionTime });
                            addLog(`${this.team} í­íƒ„ë³‘ì´ ${target.team}ì—ê²Œ í­íƒ„ì„ ì„¤ì¹˜í–ˆìŠµë‹ˆë‹¤!`, false);
                            this.nextAttackTime = now + this.attackSpeed;
                        }
                    }
                    return;
                }

                const team1Side = document.getElementById('team1-side');
                const team2Side = document.getElementById('team2-side');
                
                let unitAbsX, unitAbsY, targetAbsX, targetAbsY;
                
                if (team1Side && team2Side) {
                    const team1Rect = team1Side.getBoundingClientRect();
                    const team2Rect = team2Side.getBoundingClientRect();
                    
                    if (this.team === units.team1[0].team) {
                        unitAbsX = team1Rect.left + this.x;
                        unitAbsY = team1Rect.top + this.y;
                        targetAbsX = team2Rect.left + target.x;
                        targetAbsY = team2Rect.top + target.y;
                    } else {
                        unitAbsX = team2Rect.left + this.x;
                        unitAbsY = team2Rect.top + this.y;
                        targetAbsX = team1Rect.left + target.x;
                        targetAbsY = team1Rect.top + target.y;
                    }
                    
                    const dx = targetAbsX - unitAbsX;
                    const dy = targetAbsY - unitAbsY;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance > this.range) return;
                }

               let damage = this.damage * damageMultiplier;

                let attackDelay = this.attackSpeed;

                if (Math.random() * 100 < this.specialChance) {
                    damage = Math.floor(damage * 1.2);
                    this.flashHealthBar();
                    addLog(`${this.team} ${this.type === 'knight' ? 'ê¸°ì‚¬' : this.type === 'archer' ? 'ê¶ìˆ˜' : ''} ì¹˜ëª…! (+20%) (${Math.floor(damage)} ë°ë¯¸ì§€)`, true);
                }

                if (this.type === 'knight') {
                    this.createSlashEffect(target);
                } else if (this.type === 'archer') {
                    this.createArrowEffect(target);
                } else if (this.type === 'golem') {
                    this.createSplashEffect(target);
                }

                target.takeDamage(damage);
                
               // attack í•¨ìˆ˜ì˜ ì‚¬íƒ„ ë¹™ì˜ ë¶€ë¶„ì„ ì´ë ‡ê²Œ ìˆ˜ì •:
if (this.type === 'satan' && target.alive && !target.isPossessed && target.type !== 'angel' && target.type !== 'cave') {
    
    // â˜… ë§¤ë²ˆ ë°ë¯¸ì§€ ì ìš©
    let damage = this.damage * damageMultiplier;
    target.takeDamage(damage);
    addLog(`${this.team} ì‚¬íƒ„ì´ ${target.team}ë¥¼ ê³µê²©! (${Math.floor(damage)} ë°ë¯¸ì§€)`, false);
    
    // ì£½ì—ˆìœ¼ë©´ ë¹™ì˜ ì•ˆí•¨
    if (!target.alive) {
        this.nextAttackTime = now + this.attackSpeed;
        return;
    }
    
    // â˜… ë¹™ì˜ ì „ ì¶”ê°€ 30 HP ê°ì†Œ
    target.hp -= 0;
    if (target.hp <= 0) {
        target.hp = 0;
        target.alive = false;
        target.element.classList.add('dead');
        setTimeout(() => {
            if (target.element && target.element.parentNode) {
                target.element.parentNode.removeChild(target.element);
            }
        }, 1000);
        this.nextAttackTime = now + this.attackSpeed;
        addLog(`${target.team}ì´(ê°€) ë¹™ì˜ ì¤‘ ì‚¬ë§í–ˆìŠµë‹ˆë‹¤!`, false);
        return;
    }
    target.updateDisplay();
    addLog(`${this.team} ì‚¬íƒ„ì˜ ë¹™ì˜ë¡œ ì¶”ê°€ 30 ë°ë¯¸ì§€!`, true);
    
    // ë¹™ì˜
    target.isPossessed = true;
    target.originalTeam = target.team;  
  
    // â˜… ë¹™ì˜
    target.isPossessed = true;
    target.originalTeam = target.team;
    target.originalType = target.type;
    target.originalMaxHp = target.maxHp;
    target.originalCurrentHp = target.hp; 
    target.originalDamage = target.damage;
    target.originalAttackSpeed = target.attackSpeed;
    target.originalRange = target.range;
    target.originalSpeed = target.speed;
    target.originalBaseDamage = target.baseDamage || target.damage;
    target.originalBaseAttackSpeed = target.baseAttackSpeed || target.attackSpeed;
    
    // (ë‚˜ë¨¸ì§€ ë¹™ì˜ ë¡œì§ ê³„ì†...)
    // ë°°ì—´ì—ì„œ ì´ë™
    const enemyArray = target.team === units.team1[0].team ? units.team1 : units.team2;
    const allyArray = this.team === units.team1[0].team ? units.team1 : units.team2;
    
    const index = enemyArray.indexOf(target);
    if (index > -1) {
        enemyArray.splice(index, 1);
    }
    allyArray.push(target);
    
    // DOM elementë„ ì´ë™
    const enemySide = target.team === units.team1[0].team ? document.getElementById('team1-side') : document.getElementById('team2-side');
    const allySide = this.team === units.team1[0].team ? document.getElementById('team1-side') : document.getElementById('team2-side');
    
    // â˜… í˜„ì¬ ì ˆëŒ€ ìœ„ì¹˜ ì €ì¥
    const team1Side = document.getElementById('team1-side');
    const team2Side = document.getElementById('team2-side');
    const team1Rect = team1Side.getBoundingClientRect();
    const team2Rect = team2Side.getBoundingClientRect();
    
    const targetWasInTeam1 = target.team === units.team1[0].team;
    const targetOldRect = targetWasInTeam1 ? team1Rect : team2Rect;
    const targetAbsX = targetOldRect.left + target.x;
    const targetAbsY = targetOldRect.top + target.y;
    
    if (target.element.parentNode === enemySide) {
        enemySide.removeChild(target.element);
        allySide.appendChild(target.element);
        
        // â˜… ì ˆëŒ€ ìœ„ì¹˜ë¥¼ ìƒˆë¡œìš´ sideì˜ ìƒëŒ€ ìœ„ì¹˜ë¡œ ë³€í™˜
        const newRect = this.team === units.team1[0].team ? team1Rect : team2Rect;
        target.x = targetAbsX - newRect.left;
        target.y = targetAbsY - newRect.top;
        target.element.style.transform = `translate(${target.x}px, ${target.y}px)`;
    }
    
    // (ë‚˜ë¨¸ì§€ ì½”ë“œ ê³„ì†... ì£¼ë³€ ìœ ë‹› ë°€ì¹˜ê¸°, ëŠ¥ë ¥ì¹˜ ë³€ê²½ ë“±)
    
    // â˜… ì£¼ë³€ ìœ ë‹› ë°€ì³ë‚´ê¸°
// â˜… ì£¼ë³€ ì êµ°ë§Œ ë°€ì³ë‚´ê¸°
const pushRadius = 150;
const pushStrength = 100;
const pushDamage = 10;  // â˜… ë°€ì¹¨ ë°ë¯¸ì§€
const enemies = this.team === units.team1[0].team ? units.team2 : units.team1;

enemies.forEach(u => {
    if (u !== target && u.alive) {
        const uInTeam1 = units.team1.includes(u);
        const uRect = uInTeam1 ? team1Rect : team2Rect;
        const uSide = uInTeam1 ? team1Side : team2Side;
        const uAbsX = uRect.left + u.x;
        const uAbsY = uRect.top + u.y;
        
        const dx = uAbsX - targetAbsX;
        const dy = uAbsY - targetAbsY;
        const distance = Math.sqrt(dx * dx + dy * dy);
        
        if (distance < pushRadius && distance > 0) {
            const pushX = (dx / distance) * pushStrength;
            const pushY = (dy / distance) * pushStrength;
            
            u.x = Math.max(20, Math.min(uSide.offsetWidth - 40, u.x + pushX));
            u.y = Math.max(20, Math.min(uSide.offsetHeight - 40, u.y + pushY));
            u.element.style.transform = `translate(${u.x}px, ${u.y}px)`;
            
            // â˜… ì¶”ê°€ ë°ë¯¸ì§€
            u.takeDamage(pushDamage);
            addLog(`${u.team}ì´(ê°€) ë¹™ì˜ ì¶©ê²©íŒŒë¡œ ${pushDamage} ë°ë¯¸ì§€!`, false);
        }
    }
});

    // íŒ€ê³¼ ëŠ¥ë ¥ì¹˜ ë³€ê²½
    target.team = this.team;
    target.type = 'orc';
    target.maxHp = 110;
    target.hp = target.maxHp;
    target.baseDamage = 20;
    target.damage = 20;
    target.baseAttackSpeed = 2500;
    target.attackSpeed = 2500;
    target.range = 120;
    target.speed = 2.5;
    target.possessionEndTime = now + this.possessionDuration;
    target.isInvincible = true;
    
    // ì•„ë°”íƒ€ ë³€ê²½
    const avatar = target.element.querySelector('.soldier-avatar');
    if (avatar) {
        avatar.textContent = 'ğŸ–¤';
        avatar.style.filter = 'hue-rotate(180deg)';
    }
    
    // CSS í´ë˜ìŠ¤ ë³€ê²½
    target.element.classList.remove('team1', 'team2');
    if (this.team === units.team1[0].team) {
        target.element.classList.add('team1');
    } else {
        target.element.classList.add('team2');
    }
    
    target.updateDisplay();
    target.setTeamColor();
    
    addLog(`${this.team} ì‚¬íƒ„ì´ ${target.originalTeam}ì˜ ${target.originalType}ì„(ë¥¼) ë¹™ì˜ì‹œì¼œ ì˜¤í¬ë¡œ ë§Œë“¤ì—ˆìŠµë‹ˆë‹¤! (4ì´ˆê°„)`, true);
}

                if (this.type === 'hammerman' && this.splashRange) {
                    const team1Side = document.getElementById('team1-side');
                    const team2Side = document.getElementById('team2-side');
                    const enemies = this.team === units.team1[0].team ? units.team2 : units.team1;
                    if (team1Side && team2Side) {
                        const team1Rect = team1Side.getBoundingClientRect();
                        const team2Rect = team2Side.getBoundingClientRect();
                        const targetRect = this.team === units.team1[0].team ? team2Rect : team1Rect;
                        const targetSide = this.team === units.team1[0].team ? team2Side : team1Side;

                        const pushAmount = 120;
                        if (target && target.alive) {
                            if (this.team === units.team1[0].team) {
                                target.x = Math.min(target.x + pushAmount, targetSide.offsetWidth - 40);
                            } else {
                                target.x = Math.max(target.x - pushAmount, 40);
                            }
                            target.element.style.transform = `translate(${target.x}px, ${target.y}px)`;
                        }

                        enemies.forEach(enemy => {
                            if (enemy !== target && enemy.alive) {
                                const enemyAbsX = targetRect.left + enemy.x;
                                const enemyAbsY = targetRect.top + enemy.y;
                                const targetAbsX = targetRect.left + target.x;
                                const targetAbsY = targetRect.top + target.y;
                                const distToEnemy = Math.sqrt((enemyAbsX - targetAbsX) ** 2 + (enemyAbsY - targetAbsY) ** 2);
                                if (distToEnemy <= this.splashRange) {
                                    const splashDamage = Math.floor(damage * 0.5);
                                    enemy.takeDamage(splashDamage);
                                    addLog(`${this.team} í•´ë¨¸ë§¨ì˜ ìŠ¤í”Œë˜ì‹œ! (${Math.floor(splashDamage)} ë°ë¯¸ì§€)`, false);
                                    if (this.team === units.team1[0].team) {
                                        enemy.x = Math.min(enemy.x + pushAmount, targetSide.offsetWidth - 40);
                                    } else {
                                        enemy.x = Math.max(enemy.x - pushAmount, 40);
                                    }
                                    enemy.element.style.transform = `translate(${enemy.x}px, ${enemy.y}px)`;
                                }
                            }
                        });
                        addLog(`${this.team} í•´ë¨¸ë§¨ì˜ ê°•íƒ€ë¡œ ì ë“¤ì´ ë„‰ë°±ë˜ì—ˆìŠµë‹ˆë‹¤!`, true);
                    }
                }
                
                if (this.type === 'golem' && this.splashRange) {
                    const team1Side = document.getElementById('team1-side');
                    const team2Side = document.getElementById('team2-side');
                    const enemies = this.team === units.team1[0].team ? units.team2 : units.team1;
                    
                    if (team1Side && team2Side) {
                        const team1Rect = team1Side.getBoundingClientRect();
                        const team2Rect = team2Side.getBoundingClientRect();
                        const targetRect = this.team === units.team1[0].team ? team2Rect : team1Rect;
                        
                        enemies.forEach(enemy => {
                            if (enemy !== target && enemy.alive) {
                                const enemyAbsX = targetRect.left + enemy.x;
                                const enemyAbsY = targetRect.top + enemy.y;
                                const targetAbsX = targetRect.left + target.x;
                                const targetAbsY = targetRect.top + target.y;
                                
                                const distToEnemy = Math.sqrt((enemyAbsX - targetAbsX) ** 2 + (enemyAbsY - targetAbsY) ** 2);
                                if (distToEnemy <= this.splashRange) {
                                    const splashDamage = damage * 0.5;
                                    enemy.takeDamage(splashDamage);
                                    addLog(`${this.team} ê³¨ë ˜ì˜ ìŠ¤í”Œë˜ì‹œ! (${Math.floor(splashDamage)} ë°ë¯¸ì§€)`, false);
                                }
                            }
                        });
                    }
                }
                
                const typeLabel = this.type === 'knight' ? 'ê¸°ì‚¬' : this.type === 'archer' ? 'ê¶ìˆ˜' : this.type === 'snowman' ? 'ìƒˆì¡ì´' : this.type === 'healer' ? 'íëŸ¬' : this.type === 'shielder' ? 'ì‰´ë”' : this.type === 'hammerman' ? 'í•´ë¨¸ë§¨' : this.type === 'ninja' ? 'ë‹Œì' : this.type === 'orc' ? 'ì˜¤í¬' : this.type === 'angel' ? 'ì²œì‚¬' : 'ê³¨ë ˜';
                if (this.type !== 'golem' && this.type !== 'angel') {
                    addLog(`${this.team} ${typeLabel}ê°€ ${target.team}ë¥¼ ê³µê²©! (${Math.floor(damage)} ë°ë¯¸ì§€)`, false);
                } else if (this.type === 'golem') {
                    addLog(`${this.team} ê³¨ë ˜ì´ ${target.team}ë¥¼ ê³µê²©! (${Math.floor(damage)} ë°ë¯¸ì§€)`, false);
                }

                this.nextAttackTime = now + attackDelay;
            }

            createSlashEffect(target) {}
            createArrowEffect(target) {}
            createCritEffect(text) {}
            createSplashEffect(target) {}

            flashHealthBar() {
                const healthFill = this.infoElement.querySelector('.health-fill');
                if (healthFill) {
                    healthFill.classList.remove('special-flash');
                    void healthFill.offsetWidth;
                    healthFill.classList.add('special-flash');
                }
            }

            showCooldownReduction() {
                const indicator = document.createElement('div');
                indicator.className = 'cooldown-reduction';
                indicator.textContent = 'ğŸ•';
                this.element.appendChild(indicator);
                setTimeout(() => indicator.remove(), 600);
            }
            
            updateReviveCounter() {
                if (this.type === 'angel') {
                    const details = this.element.querySelector('.soldier-details');
                    if (details) {
                        let counterDiv = details.querySelector('.revive-counter');
                        if (!counterDiv) {
                            counterDiv = document.createElement('div');
                            counterDiv.className = 'revive-counter';
                            counterDiv.style.cssText = 'color: gold; font-size: 11px; font-weight: bold;';
                            details.appendChild(counterDiv);
                        }
                        counterDiv.textContent = `ë¶€í™œ: ${this.reviveCount}`;
                    }
                }
            }
        
        updateChargeDisplay() {
    if (this.type === 'unicorn') {
        const chargeDiv = this.element.querySelector('.charge-level');
        if (chargeDiv) {
            chargeDiv.textContent = `ì°¨ì§€: ${this.chargeLevel}/6 (${this.damage} dmg)`;
        }
    }
}
        }

        function startBattle() {
            if (battleActive) return;
            
            resetBattle();
            battleActive = true;

            const team1Name = document.getElementById('team1Name').value;
            const team2Name = document.getElementById('team2Name').value;

       const unitTypes = [
    { name: 'Knight' },
    { name: 'Archer' },
    { name: 'Snowman' },
    { name: 'Golem' },
    { name: 'Shielder' },
    { name: 'Healer' },
    { name: 'Bomberman' },
    { name: 'Hammerman' },
    { name: 'Ninja' },
    { name: 'Orc' },
    { name: 'Angel' },
    { name: 'Satan' },
    { name: 'Cave' },
    { name: 'Unicorn' }
];

            for (let i = 0; i < 2; i++) {
                const teamId = i + 1;
                const teamArray = units[`team${teamId}`];
                const teamName = teamId === 1 ? team1Name : team2Name;

                for (const unitConfig of unitTypes) {
                    const unitType = unitConfig.name;
                    const frontId = `team${teamId}${unitType}FrontCount`;
                    const backId = `team${teamId}${unitType}BackCount`;
                    const specialId = `team${teamId}${unitType}Special`;

                    const frontCount = parseInt(document.getElementById(frontId)?.value || '0');
                    const backCount = parseInt(document.getElementById(backId)?.value || '0');
                    const star = 1;
                    const special = parseInt(document.getElementById(specialId)?.value || '0');

                    for (let j = 0; j < frontCount; j++) {
                        const u = new Unit(unitType.toLowerCase(), teamName, star, special, j);
                        u.row = 'front';
                        if (unitType.toLowerCase() === 'cave') {
                            u.spawnType = document.getElementById(`team${teamId}CaveSpawnType`).value;
                        }
                        teamArray.push(u);
                    }
                    for (let j = 0; j < backCount; j++) {
                        const u = new Unit(unitType.toLowerCase(), teamName, star, special, j + frontCount);
                        u.row = 'back';
                        if (unitType.toLowerCase() === 'cave') {
                            u.spawnType = document.getElementById(`team${teamId}CaveSpawnType`).value;
                        }
                        teamArray.push(u);
                    }
                }
            }

            renderBattlefield();
            addLog('âš”ï¸ ì „íˆ¬ ì‹œì‘! âš”ï¸');

            setBattleInterval();
        }

        function renderBattlefield() {
            battlefield.innerHTML = `
                <div class="armies-container">
                    <div class="army-side" id="team1-side">
                        <h3 id="team1-name"></h3>
                    </div>
                    <div class="army-side" id="team2-side">
                        <h3 id="team2-name"></h3>
                    </div>
                </div>
            `;

            const team1Side = document.getElementById('team1-side');
            const team2Side = document.getElementById('team2-side');

            document.getElementById('team1-name').textContent = units.team1[0].team;
            document.getElementById('team2-name').textContent = units.team2[0].team;

            const team1SideEl = document.getElementById('team1-side');
            const team2SideEl = document.getElementById('team2-side');
            if (!document.getElementById('team1-counts')) {
                const c1 = document.createElement('div');
                c1.id = 'team1-counts';
                c1.className = 'team-counts';
                c1.innerHTML = `<div class="summary">ë‚¨ì€: 0</div><div class="details"></div>`;
                team1SideEl.appendChild(c1);
            }
            if (!document.getElementById('team2-counts')) {
                const c2 = document.createElement('div');
                c2.id = 'team2-counts';
                c2.className = 'team-counts';
                c2.innerHTML = `<div class="summary">ë‚¨ì€: 0</div><div class="details"></div>`;
                team2SideEl.appendChild(c2);
            }

            updateTeamCounts();

            units.team1.forEach((unit, idx) => {
                const w = team1Side.offsetWidth;
                if (unit.row === 'front') {
                    unit.x = Math.floor(w * 0.45) + Math.random() * 40;
                    unit.y = 80 + (idx % 3) * 100 + Math.random() * 30;
                } else {
                    unit.x = 20 + Math.random() * 40;
                    unit.y = 120 + (idx % 3) * 120 + Math.random() * 40;
                }
                unit.element.style.transform = `translate(${unit.x}px, ${unit.y}px)`;
                team1Side.appendChild(unit.element);
                unit.element.classList.add('team1');
                unit.setTeamColor();
            });

            units.team2.forEach((unit, idx) => {
                const w = team2Side.offsetWidth;
                if (unit.row === 'front') {
                    unit.x = Math.floor(w * 0.05) + Math.random() * 40 + w * 0.45;
                    unit.y = 80 + (idx % 3) * 100 + Math.random() * 30;
                } else {
                    unit.x = w - 60 + Math.random() * 40;
                    unit.y = 120 + (idx % 3) * 120 + Math.random() * 40;
                }
                unit.element.style.transform = `translate(${unit.x}px, ${unit.y}px)`;
                team2Side.appendChild(unit.element);
                unit.element.classList.add('team2');
                unit.setTeamColor();
            });
        }

        function battleLoop() {
            const now = Date.now();

                 [...units.team1, ...units.team2].forEach(u => {
     // battleLoopì˜ ë¹™ì˜ í•´ì œ ë¶€ë¶„ì„ ì´ë ‡ê²Œ ìˆ˜ì •:
// battleLoopì˜ ë¹™ì˜ í•´ì œ ë¶€ë¶„ì„ ì´ë ‡ê²Œ ìˆ˜ì •:
if (u.isPossessed && u.alive && u.possessionEndTime && now >= u.possessionEndTime) {
    // â˜… í˜„ì¬ ì–´ëŠ sideì— ìˆëŠ”ì§€ ì •í™•íˆ í™•ì¸
    const team1Side = document.getElementById('team1-side');
    const team2Side = document.getElementById('team2-side');
    const currentSide = u.element.parentNode;  // â˜… ì‹¤ì œ ë¶€ëª¨ ë…¸ë“œ í™•ì¸
    const originalSide = u.originalTeam === units.team1[0]?.team ? team1Side : team2Side;
    
    // ë°°ì—´ ì´ë™
    const currentArray = units.team1.includes(u) ? units.team1 : units.team2;
    const originalArray = u.originalTeam === units.team1[0]?.team ? units.team1 : units.team2;
    
    if (currentArray !== originalArray) {
        const index = currentArray.indexOf(u);
        if (index > -1) {
            currentArray.splice(index, 1);
        }
        originalArray.push(u);
    }
    
    if (currentSide !== originalSide) {
        // í˜„ì¬ ì ˆëŒ€ ìœ„ì¹˜ ê³„ì‚° (ì˜¤í¬ì˜ í˜„ì¬ ìœ„ì¹˜)
        const team1Rect = team1Side.getBoundingClientRect();
        const team2Rect = team2Side.getBoundingClientRect();
        
        const currentRect = currentSide === team1Side ? team1Rect : team2Rect;
        const uAbsX = currentRect.left + u.x;
        const uAbsY = currentRect.top + u.y;
        
        // DOM ì´ë™
        currentSide.removeChild(u.element);
        originalSide.appendChild(u.element);
        
        // ì ˆëŒ€ ìœ„ì¹˜ë¥¼ ì›ë˜ sideì˜ ìƒëŒ€ ìœ„ì¹˜ë¡œ ë³€í™˜
        const originalRect = originalSide === team1Side ? team1Rect : team2Rect;
        u.x = uAbsX - originalRect.left;
        u.y = uAbsY - originalRect.top;
        u.element.style.transform = `translate(${u.x}px, ${u.y}px)`;
    }
    
    // ì›ìƒë³µêµ¬
u.team = u.originalTeam;
u.type = u.originalType;

// â˜… ì˜¤í¬ ì²´ë ¥ ì™„ì „ ë¬´ì‹œ! ì›ë˜ ìœ ë‹› HPë§Œ ì‚¬ìš©
u.maxHp = u.originalMaxHp;
u.hp = u.originalCurrentHp - 40;  // ë¹™ì˜ ì§ì „ HPì—ì„œ 30 ê°ì†Œ

if (u.hp <= 0) {
    u.hp = 0;
    u.alive = false;
    u.element.classList.add('dead');
    setTimeout(() => {
        if (u.element && u.element.parentNode) {
            u.element.parentNode.removeChild(u.element);
        }
    }, 1000);
}

u.baseDamage = u.originalBaseDamage;
u.damage = u.originalDamage;
u.baseAttackSpeed = u.originalBaseAttackSpeed;
u.attackSpeed = u.originalAttackSpeed;
u.range = u.originalRange;
u.speed = u.originalSpeed;
u.isPossessed = false;
u.isInvincible = false;

u.updateDisplay();



    
    // ì•„ë°”íƒ€ ë³µêµ¬
    const avatar = u.element.querySelector('.soldier-avatar');
    if (avatar) {
        const icons = {
            'knight': 'ğŸ—¡ï¸', 'archer': 'ğŸ¹', 'snowman': 'ğŸ¦',
            'healer': 'âš•ï¸', 'shielder': 'ğŸ›¡ï¸', 'bomberman': 'ğŸ’£',
            'hammerman': 'ğŸ”¨', 'ninja': 'ğŸ¥·', 'orc': 'ğŸ‘¹',
            'golem': 'ğŸ—¿', 'angel': 'ğŸ‘¼', 'satan': 'ğŸ˜ˆ', 'cave': 'ğŸ›–'
        };
        avatar.textContent = icons[u.originalType] || 'ğŸ—¡ï¸';
        avatar.style.filter = '';
    }
    
    // CSS ë³µêµ¬
    u.element.classList.remove('team1', 'team2');
    if (u.originalTeam === units.team1[0]?.team) {
        u.element.classList.add('team1');
    } else {
        u.element.classList.add('team2');
    }
    
    u.updateDisplay();
    u.setTeamColor();
    
    addLog(`${u.originalTeam}ì˜ ${u.originalType}ì´(ê°€) ë¹™ì˜ì—ì„œ ë²—ì–´ë‚¬ìŠµë‹ˆë‹¤!`, true);
}
                 });
    
            [units.team1, units.team2].flat().forEach(u => {
                if (!u || !u.alive) return;
                
                if (u.type === 'shielder' && u.isInvincible && u.shieldEndTime && now >= u.shieldEndTime) {
                    u.isInvincible = false;
                    if (u.element && u.element.classList) u.element.classList.remove('invincible');
                    u.nextShieldTime = Date.now() + u.shieldCooldownAfterEnd;
                    addLog(`${u.team} ì‰´ë”ì˜ ë¬´ì ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ì‚¬ìš© ê°€ëŠ¥: 6ì´ˆ í›„`, false);
                    u.flashHealthBar();
                    u.shieldEndTime = 0;
                }
                
                [units.team1, units.team2].flat().forEach(u => {
                    if (!u) return;
                    if (u.type === 'ninja' && u.alive === false && !u.hasRetreated) {
                        if (u.deathTimeout) {
                            clearTimeout(u.deathTimeout);
                            u.deathTimeout = null;
                        }
                        
                        u.alive = true;
                        u.hasRetreated = true;
                        u.range = 450;
                        u.attackSpeed = 4200;
                        u.damage = 20;
                        u.hp = 70;
                        
                        const team1Side = document.getElementById('team1-side');
                        const team2Side = document.getElementById('team2-side');
                        const sideEl = u.team === units.team1[0].team ? team1Side : team2Side;
                        
                        if (u.team === units.team1[0].team) {
                            u.x = Math.max(0, u.x - 400);
                        } else {
                            u.x = Math.min(sideEl.offsetWidth, u.x + 400);
                        }
                        
                        u.element.classList.remove('dead');
                        u.element.style.opacity = '1';
                        u.element.style.transform = `translate(${u.x}px, ${u.y}px)`;
                        
                        u.updateDisplay();
                        addLog(`${u.team} ë‹Œìê°€ í›„í‡´í–ˆìŠµë‹ˆë‹¤! ì¼ë¶€ ì²´ë ¥ì„ íšŒë³µ`, true);
                    }
                });
                
                if (u.type === 'bomberman' && u.bombs && u.bombs.length > 0) {
                    u.bombs = u.bombs.filter(bomb => {
                        if (now >= bomb.explosionTime) {
                            const target = bomb.target;
                            if (target && target.alive) {
                                target.takeDamage(u.bombDamage);
                                addLog(`${u.team} í­íƒ„ë³‘ì˜ í­íƒ„ì´ ${target.team}ì—ê²Œ í­ë°œ! (${u.bombDamage} ë°ë¯¸ì§€)`, false);
                                const enemies = u.team === units.team1[0].team ? units.team2 : units.team1;
                                const team1Side = document.getElementById('team1-side');
                                const team2Side = document.getElementById('team2-side');
                                if (team1Side && team2Side) {
                                    const team1Rect = team1Side.getBoundingClientRect();
                                    const team2Rect = team2Side.getBoundingClientRect();
                                    const targetRect = u.team === units.team1[0].team ? team2Rect : team1Rect;
                                    enemies.forEach(enemy => {
                                        if (enemy !== target && enemy.alive) {
                                            const enemyAbsX = targetRect.left + enemy.x;
                                            const enemyAbsY = targetRect.top + enemy.y;
                                            const targetAbsX = targetRect.left + target.x;
                                            const targetAbsY = targetRect.top + target.y;
                                            const distToEnemy = Math.sqrt((enemyAbsX - targetAbsX) ** 2 + (enemyAbsY - targetAbsY) ** 2);
                                            if (distToEnemy <= u.bombSplashRange) {
                                                const splashDamage = u.bombDamage * 0.5;
                                                enemy.takeDamage(splashDamage);
                                                addLog(`${u.team} í­íƒ„ë³‘ì˜ ìŠ¤í”Œë˜ì‹œ! (${Math.floor(splashDamage)} ë°ë¯¸ì§€)`, false);
                                            }
                                        }
                                    });
                                }
                            }
                            u.takeDamage(u.bombSelfDamage);
                            addLog(`${u.team} í­íƒ„ë³‘ì´ ìì‹ ì˜ í­íƒ„ìœ¼ë¡œ í”¼í•´ë¥¼ ì…ì—ˆìŠµë‹ˆë‹¤! (${u.bombSelfDamage} ë°ë¯¸ì§€)`, false);
                            return false;
                        }
                        return true;
                    });
                }
            });
          const aliveTeam1 = units.team1.filter(u => u.alive);
const aliveTeam2 = units.team2.filter(u => u.alive);

updateTeamCounts();

if (aliveTeam1.length === 0 || aliveTeam2.length === 0) {
    endBattle(aliveTeam1.length > 0 ? units.team1[0].team : units.team2[0].team);
    return;
}

const allUnits = [...units.team1, ...units.team2];
const team1Name = units.team1[0]?.team;
const team2Name = units.team2[0]?.team;

const actualTeam1 = allUnits.filter(u => u.alive && u.team === team1Name);
const actualTeam2 = allUnits.filter(u => u.alive && u.team === team2Name);

actualTeam1.forEach(unit => {
    let closestTarget = null;
    let closestDistance = Infinity;
    
    actualTeam2.forEach(target => {
        const team1Rect = document.getElementById('team1-side').getBoundingClientRect();
        const team2Rect = document.getElementById('team2-side').getBoundingClientRect();
        
        // â˜… í•µì‹¬: ìœ ë‹›ì´ ì–´ëŠ ë°°ì—´ì— ì†í•´ìˆëŠ”ì§€ í™•ì¸
        const unitInTeam1Array = units.team1.includes(unit);
        const targetInTeam1Array = units.team1.includes(target);
        
        const unitAbsX = (unitInTeam1Array ? team1Rect.left : team2Rect.left) + unit.x;
        const unitAbsY = (unitInTeam1Array ? team1Rect.top : team2Rect.top) + unit.y;
        const targetAbsX = (targetInTeam1Array ? team1Rect.left : team2Rect.left) + target.x;
        const targetAbsY = (targetInTeam1Array ? team1Rect.top : team2Rect.top) + target.y;
        
        const distance = Math.sqrt((targetAbsX - unitAbsX) ** 2 + (targetAbsY - unitAbsY) ** 2);
        if (distance < closestDistance) {
            closestDistance = distance;
            closestTarget = target;
        }
    });
    
    if (closestTarget) {
        unit.moveTowards(closestTarget);
        unit.attack(closestTarget);
    }
});

actualTeam2.forEach(unit => {
    let closestTarget = null;
    let closestDistance = Infinity;
    
    actualTeam1.forEach(target => {
        const team1Rect = document.getElementById('team1-side').getBoundingClientRect();
        const team2Rect = document.getElementById('team2-side').getBoundingClientRect();
        
        // â˜… í•µì‹¬: ìœ ë‹›ì´ ì–´ëŠ ë°°ì—´ì— ì†í•´ìˆëŠ”ì§€ í™•ì¸
        const unitInTeam1Array = units.team1.includes(unit);
        const targetInTeam1Array = units.team1.includes(target);
        
        const unitAbsX = (unitInTeam1Array ? team1Rect.left : team2Rect.left) + unit.x;
        const unitAbsY = (unitInTeam1Array ? team1Rect.top : team2Rect.top) + unit.y;
        const targetAbsX = (targetInTeam1Array ? team1Rect.left : team2Rect.left) + target.x;
        const targetAbsY = (targetInTeam1Array ? team1Rect.top : team2Rect.top) + target.y;
        
        const distance = Math.sqrt((targetAbsX - unitAbsX) ** 2 + (targetAbsY - unitAbsY) ** 2);
        if (distance < closestDistance) {
            closestDistance = distance;
            closestTarget = target;
        }
    });
    
    if (closestTarget) {
        unit.moveTowards(closestTarget);
        unit.attack(closestTarget);
    }
});
        }
        function updateTeamCounts() {
            const team1CountsEl = document.getElementById('team1-counts');
            const team2CountsEl = document.getElementById('team2-counts');
            if (!team1CountsEl || !team2CountsEl) return;

            const summarize = (arr) => {
                const alive = arr.filter(u => u.alive);
                const total = alive.length;
                const byType = {};
                alive.forEach(u => {
                    const key = `${u.type} (${u.row})`;
                    byType[key] = (byType[key] || 0) + 1;
                });
                return { total, byType };
            };

            const t1 = summarize(units.team1);
            const t2 = summarize(units.team2);

            team1CountsEl.querySelector('.summary').textContent = `ë‚¨ì€: ${t1.total}`;
            team2CountsEl.querySelector('.summary').textContent = `ë‚¨ì€: ${t2.total}`;

            const makeDetails = (byType) => {
                return Object.keys(byType).map(k => `${k}: ${byType[k]}`).join('<br>') || 'ì—†ìŒ';
            };

            team1CountsEl.querySelector('.details').innerHTML = makeDetails(t1.byType);
            team2CountsEl.querySelector('.details').innerHTML = makeDetails(t2.byType);
        }

        function endBattle(winner) {
            clearInterval(battleInterval);
            battleActive = false;
            
            const announce = document.createElement('div');
            announce.className = 'winner-announce';
            announce.textContent = `ğŸ† ${winner} ìŠ¹ë¦¬! ğŸ†`;
            document.body.appendChild(announce);
            
            addLog(`ğŸ† ${winner} ìŠ¹ë¦¬!`);
            
            setTimeout(() => announce.remove(), 4000);
        }

        function resetBattle() {
            clearInterval(battleInterval);
            battleActive = false;
            units = { team1: [], team2: [] };
            battlefield.innerHTML = '';
            document.getElementById('battleLog').innerHTML = '';
            damageMultiplier = 1.0;
            document.getElementById('damageBtn').textContent = 'ğŸ’ª ê³µê²©ë ¥ +100% (100%)';
        }

        function addLog(message, isSpecial = false) {
            const log = document.getElementById('battleLog');
            const entry = document.createElement('div');
            entry.className = isSpecial ? 'log-entry special' : 'log-entry damage';
            const time = new Date().toLocaleTimeString('ko-KR', { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            entry.textContent = `[${time}] ${message}`;
            log.insertBefore(entry, log.firstChild);
            
            if (log.children.length > 50) {
                log.removeChild(log.lastChild);
            }
        }
    </script>
</body>
</html>
